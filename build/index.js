(()=>{"use strict";var e,t={55:()=>{const e=window.wp.i18n,t=window.wp.blocks,r=window.wp.blockEditor,s=window.wp.components,i=window.wp.element,a=window.wp.primitives,n=window.ReactJSXRuntime,o=(0,n.jsx)(a.SVG,{viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg",children:(0,n.jsx)(a.Path,{d:"M12 9.2c-2.2 0-3.9 1.8-3.9 4s1.8 4 3.9 4 4-1.8 4-4-1.8-4-4-4zm0 6.5c-1.4 0-2.4-1.1-2.4-2.5s1.1-2.5 2.4-2.5 2.5 1.1 2.5 2.5-1.1 2.5-2.5 2.5zM20.2 8c-.1 0-.3 0-.5-.1l-2.5-.8c-.4-.1-.8-.4-1.1-.8l-1-1.5c-.4-.5-1-.9-1.7-.9h-2.9c-.6.1-1.2.4-1.6 1l-1 1.5c-.3.3-.6.6-1.1.7l-2.5.8c-.2.1-.4.1-.6.1-1 .2-1.7.9-1.7 1.9v8.3c0 1 .9 1.9 2 1.9h16c1.1 0 2-.8 2-1.9V9.9c0-1-.7-1.7-1.8-1.9zm.3 10.1c0 .2-.2.4-.5.4H4c-.3 0-.5-.2-.5-.4V9.9c0-.1.2-.3.5-.4.2 0 .5-.1.8-.2l2.5-.8c.7-.2 1.4-.6 1.8-1.3l1-1.5c.1-.1.2-.2.4-.2h2.9c.2 0 .3.1.4.2l1 1.5c.4.7 1.1 1.1 1.9 1.4l2.5.8c.3.1.6.1.8.2.3 0 .4.2.4.4v8.1z"})}),c=(0,n.jsx)(a.SVG,{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",children:(0,n.jsx)(a.Path,{fillRule:"evenodd",d:"M10.289 4.836A1 1 0 0111.275 4h1.306a1 1 0 01.987.836l.244 1.466c.787.26 1.503.679 2.108 1.218l1.393-.522a1 1 0 011.216.437l.653 1.13a1 1 0 01-.23 1.273l-1.148.944a6.025 6.025 0 010 2.435l1.149.946a1 1 0 01.23 1.272l-.653 1.13a1 1 0 01-1.216.437l-1.394-.522c-.605.54-1.32.958-2.108 1.218l-.244 1.466a1 1 0 01-.987.836h-1.306a1 1 0 01-.986-.836l-.244-1.466a5.995 5.995 0 01-2.108-1.218l-1.394.522a1 1 0 01-1.217-.436l-.653-1.131a1 1 0 01.23-1.272l1.149-.946a6.026 6.026 0 010-2.435l-1.148-.944a1 1 0 01-.23-1.272l.653-1.131a1 1 0 011.217-.437l1.393.522a5.994 5.994 0 012.108-1.218l.244-1.466zM14.929 12a3 3 0 11-6 0 3 3 0 016 0z",clipRule:"evenodd"})}),l=window.wp.data,d=window.wp.notices,m=(0,i.createContext)({isSelected:void 0,content:void 0,svg:void 0,updateContext:()=>{}});function u({refreshTrigger:t}){const[r,s]=(0,i.useState)(!1),a=(0,i.useRef)(null),{content:o,updateContext:c}=(0,i.useContext)(m),l=(0,i.useCallback)((async function(e){try{await window.mermaid.parse(e),s(!1),a.current?.removeAttribute("data-processed"),a.current.innerHTML=e;const t=()=>new Promise((e=>{window.mermaid.run({nodes:[a.current],postRenderCallback:()=>{const t=a.current.querySelector("svg");e(t)}})})),r=await t();c({svg:r})}catch(e){console.error(e),c({svg:{}}),s(!0)}}),[c]);return(0,i.useEffect)((()=>{l(o)}),[o,l,t]),(0,n.jsxs)(n.Fragment,{children:[r&&(0,n.jsx)("div",{className:"error",children:(0,e.__)("Syntax Error","merpress")}),(0,n.jsx)("div",{ref:a,className:"mermaid "+(r?"mermaid-error":"")})]})}const g=window.wp.mediaUtils,h=Object.freeze({NOT_SAVED:{value:0,label:"not saved"},SAVING:{value:1,label:"saving"},SAVED:{value:2,label:"saved"}}),p=Object.freeze({MERMAID:"mermaid",IMAGE:"image"}),w=JSON.parse('{"$schema":"https://schemas.wp.org/trunk/block.json","apiVersion":2,"name":"merpress/mermaidjs","title":"MerPress","category":"formatting","icon":"chart-pie","description":"Create diagrams and flow charts using text via Mermaid","keywords":["mermaid","chart","diagram","flow","graph"],"version":"1.1.5","textdomain":"my-plugin","attributes":{"content":{"type":"string","source":"text","selector":"pre.mermaid"},"diagramSource":{"enum":["mermaid","image"],"default":"mermaid"},"imgs":{"type":"array","source":"query","selector":"img","default":[],"query":{"src":{"type":"string","source":"attribute","attribute":"src"},"width":{"type":"number","source":"attribute","attribute":"width"},"height":{"type":"number","source":"attribute","attribute":"height"}}}},"supports":{"html":false,"align":["left","center","right","wide","full"]},"example":{"attributes":{"content":"graph TD\\nA--\x3eB\\n","img":{}}},"editorScript":["file:./index.js"],"editorStyle":["wp-edit-blocks","file:./index.css"],"script":["mermaid","file:./mermaid.js"],"style":["file:./style-index.css"],"viewScript":["file:./mermaid-init.js"]}'),v={attributes:{content:{type:"string",source:"text",selector:"pre.mermaid"}},save:({attributes:{content:e}})=>{const t=r.useBlockProps.save({className:"mermaid"});return(0,n.jsx)("pre",{...t,children:e})},migrate:e=>({...e,imgs:[],diagramSource:"mermaid"}),supports:{html:!1,className:!1}},f=window.React;function b(){return b=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var s in r)({}).hasOwnProperty.call(r,s)&&(e[s]=r[s])}return e},b.apply(null,arguments)}(0,t.registerBlockType)(w,{description:(0,n.jsxs)(n.Fragment,{children:[(0,n.jsxs)("p",{children:[(0,e.__)("Create diagrams and flow charts using text via Mermaid","merpress"),"."]}),(0,n.jsx)("a",{href:"https://mermaid.js.org/syntax/flowchart.html",children:(0,e.__)("Documentation","merpress")})]}),edit:function({attributes:t,setAttributes:a,isSelected:w}){const{content:v="",imgs:f=[],diagramSource:b=p.MERMAID,align:x}=t,[j,y]=(0,i.useState)({}),[S,k]=(0,i.useState)(h.NOT_SAVED),[M,_]=(0,i.useState)([]),[E,N]=(0,i.useState)(0),{createNotice:A,removeNotice:O}=(0,l.useDispatch)(d.store),R=(0,r.useBlockProps)({className:x?`align${x}`:""});(0,i.useEffect)((()=>{f&&f.length>0?k(h.SAVED):k(h.NOT_SAVED)}),[f]),(0,i.useEffect)((()=>{b===p.IMAGE&&f&&0===f.length&&a({diagramSource:p.MERMAID}),b===p.IMAGE?_([{id:"merpress-image-diagram",content:(0,e.__)("Using linked image. Might be out of date from diagram. (The diagram is shown here).","merpress"),status:"info",isDismissible:!1}]):_([])}),[b,f,a]);const C=(0,i.useCallback)((e=>{e&&void 0!==e.svg&&y(e.svg),e&&void 0!==e.content&&a({content:e.content})}),[a]),D={isSelected:w,content:v,svg:j,updateContext:C};return(0,i.useEffect)((()=>{N((e=>e+1))}),[x]),(0,n.jsxs)(m.Provider,{value:D,children:[(0,n.jsx)(r.BlockControls,{children:(0,n.jsxs)(s.Toolbar,{label:(0,e.__)("Merpress","merpress"),children:[(0,n.jsx)(s.ToolbarButton,{label:(0,e.__)("Store diagram as PNG","merpress"),icon:o,onClick:async()=>{k(h.SAVING);const t=await A("info",(0,e.__)("Saving diagram as PNG","merpress"),{type:"snackbar"});try{const r=await function(e){const t=(new XMLSerializer).serializeToString(e),r=new Blob([t],{type:"image/svg+xml;charset=utf-8"}),s=URL.createObjectURL(r);return new Promise(((t,r)=>{const i=new Image;i.onload=()=>{const r=document.createElement("canvas"),a=r.getContext("2d");r.width=2*e.width.baseVal.value,r.height=2*e.height.baseVal.value,a.clearRect(0,0,r.width,r.height),a.drawImage(i,0,0,r.width,r.height),URL.revokeObjectURL(s),t(r.toDataURL("image/png"))},i.onerror=e=>{URL.revokeObjectURL(s),r(e)},i.src=s}))}(j),s=await async function(e){const t=await fetch(e),r=await t.blob(),s=new File([r],"merpress.png",{type:"image/png"});return new Promise(((e,t)=>{(0,g.uploadMedia)({filesList:[s],onFileChange:([t])=>{t.id&&e(t)},onError:e=>{t(e)},allowedTypes:["image"]})}))}(r);a({imgs:[{src:s.url,width:j.width,height:j.height}]}),O(t.notice.id);const i=await A("info",(0,e.__)("Saved diagram as PNG","merpress"),{type:"snackbar"});setTimeout((()=>O(i.notice.id)),3500)}catch(t){console.log("saveImg error",t),A("error",(0,e.__)("Error saving diagram as PNG","merpress")),k(h.NOT_SAVED)}},isBusy:S===h.SAVING}),(0,n.jsx)(s.ToolbarDropdownMenu,{icon:c,label:(0,e.__)("MerPress settings","merpress"),controls:[{title:(0,e.__)("Use mermaid as diagram","merpress"),isDisabled:b===p.MERMAID,onClick:()=>{a({diagramSource:p.MERMAID})}},{title:(0,e.__)("Use image as diagram","merpress"),isDisabled:b===p.IMAGE||0===f.length,onClick:()=>{a({diagramSource:p.IMAGE})}},{title:(0,e.__)("Unset saved image","merpress"),isDisabled:S===h.NOT_SAVED,onClick:()=>{a({imgs:[]})}}]})]})}),(0,n.jsxs)("div",{...R,children:[w&&(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)("pre",{className:"mermaid-editor wp-block-code",children:(0,n.jsx)(r.PlainText,{onChange:e=>{C({content:e})},value:v,style:{backgroundColor:"inherit"}})}),(0,n.jsx)("hr",{})]}),M.length>0&&(0,n.jsx)(s.NoticeList,{notices:M,className:"merpress-notice-list"}),(0,n.jsx)(u,{refreshTrigger:E})]})]})},icon:function(e){return f.createElement("svg",b({xmlns:"http://www.w3.org/2000/svg",xmlSpace:"preserve",style:{fillRule:"evenodd",clipRule:"evenodd",strokeLinejoin:"round",strokeMiterlimit:2},viewBox:"0 0 600 600"},e),f.createElement("path",{d:"M0 0h600v600H0z",style:{fill:"#fff"}}),f.createElement("path",{d:"M282 480 142 177v241c0 22 3 36 8 41 6 8 17 12 31 12h13v9H68v-9h13c15 0 26-5 32-14q6-9 6-39V182c0-16-2-27-5-35-3-5-7-9-14-12-7-4-17-6-32-6v-9h102l131 282 129-282h102v9h-12c-16 0-27 5-33 14q-6 9-6 39v236c0 22 2 36 7 41 7 8 17 12 32 12h12v9H379v-9h13c15 0 26-5 32-14q6-9 6-39V177L291 480z",style:{fillRule:"nonzero"}}))},save:function(e){const{content:t,imgs:s,diagramSource:i,align:a}=e.attributes,o=r.useBlockProps.save({className:`diagram-source-${i}${a?` align${a}`:""}`});return(0,n.jsxs)("div",{...o,children:[(0,n.jsx)("pre",{className:"mermaid",children:t}),s.map(((e,t)=>(0,n.jsx)("img",{src:e.src,width:e.width,height:e.height,alt:""},t)))]})},deprecated:[v]})}},r={};function s(e){var i=r[e];if(void 0!==i)return i.exports;var a=r[e]={exports:{}};return t[e](a,a.exports,s),a.exports}s.m=t,e=[],s.O=(t,r,i,a)=>{if(!r){var n=1/0;for(d=0;d<e.length;d++){r=e[d][0],i=e[d][1],a=e[d][2];for(var o=!0,c=0;c<r.length;c++)(!1&a||n>=a)&&Object.keys(s.O).every((e=>s.O[e](r[c])))?r.splice(c--,1):(o=!1,a<n&&(n=a));if(o){e.splice(d--,1);var l=i();void 0!==l&&(t=l)}}return t}a=a||0;for(var d=e.length;d>0&&e[d-1][2]>a;d--)e[d]=e[d-1];e[d]=[r,i,a]},s.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),(()=>{var e={57:0,350:0};s.O.j=t=>0===e[t];var t=(t,r)=>{var i,a,n=r[0],o=r[1],c=r[2],l=0;if(n.some((t=>0!==e[t]))){for(i in o)s.o(o,i)&&(s.m[i]=o[i]);if(c)var d=c(s)}for(t&&t(r);l<n.length;l++)a=n[l],s.o(e,a)&&e[a]&&e[a][0](),e[a]=0;return s.O(d)},r=self.webpackChunkmerpress=self.webpackChunkmerpress||[];r.forEach(t.bind(null,0)),r.push=t.bind(null,r.push.bind(r))})();var i=s.O(void 0,[350],(()=>s(55)));i=s.O(i)})();